<!DOCTYPE html>
<html lang="ko-KR" class="no-js">
<head>
  <meta charset="UTF-8" />
  <title>STEP 04. 상태 전환 및 필터링</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="사용자 입력 내용으로 새 노트 추가 및 이행 상태 전환, 필터링 기능을 구현합니다." />
  <meta name="theme-color" content="#006eb4" />
  <link rel="icon" href="https://www.vectorlogo.zone/logos/w3_html5/w3_html5-icon.svg" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  
  <div id="NoteApp"></div>

  <script data-type="component-class">

    class Component {
      constructor(element) {
        this.element = element;
        this.state = {};
        this.init();
        this.bindEvents();
        this.render();
      }

      init() {}
      bindEvents() {}

      template() {
        return ``;
      }

      render() {
        this.element.innerHTML = this.template();
      }

      setState(newState) {
        this.state = { ...this.state, ...newState };
        this.render();
      }

      on(type, selector, listener) {
        this.element.addEventListener(type, (e) => {
          if (e.target.matches(selector) || e.target.closest(selector)) {
            listener(e);
          }
        });
      }

      static getRandomNumber(n) {
        return Math.floor(Math.random() * n);
      }

      static generateId({ prefix = 'euid', digit = 10 } = {}) {
        const { getRandomNumber } = Component;
        const characters = 'abcdefghijklmnopqrstuvwxyz'.split('');
        let id = `${prefix}-`;
        
        while(digit-- > 0) {
          let randomIndex = getRandomNumber(characters.length - 1);
          let randomChar = characters[randomIndex];
          if (getRandomNumber(2) > 0) { randomChar = randomChar.toUpperCase(); }
          id += randomChar;
          characters.splice(randomIndex, 1);
        }

        return id;
      }
    }

  </script>

  <script data-type="note-app-component">

    const NoteFilters = {
      all: 'ALL',
      done: 'DONE',
      dont: 'DONT'
    };

    class NoteApp extends Component {

      init() {
        this.setState({
          notes: [
            { id: 'note-jdiCk', content: '컴포넌트 작동 흐름', done: false, },
            { id: 'note-dIwjc', content: '컴포넌트 구현', done: false, },
          ],
          filter: NoteFilters.all
        });
      }

      bindEvents() {
        const { element } = this;

        this.on('click', '.addNote', (e) => {
          let noteInput = element.querySelector('.noteInput');
          let value = noteInput.value.trim?.();
          if (noteInput && value) { 
            this.addNote(value); 
          }
        });

        this.on('keyup', '.noteInput', (e) => {
          let value = e.target.value.trim?.();
          if (e.key === 'Enter' && value) {
            this.addNote(value);
          }
        });

        this.on('change', '.toggleNote', (e) => {
          this.toggleNote(e.target);
        });
        
        this.on('click', '.deleteNote', (e) => {
          this.deleteNote(e.target);
        });
        
        this.on('click', '[data-filter="all"]', (e) => {
          this.changeFilter(NoteFilters.all);
        });

        this.on('click', '[data-filter="done"]', (e) => {
          this.changeFilter(NoteFilters.done);
        });

        this.on('click', '[data-filter="dont"]', (e) => {
          this.changeFilter(NoteFilters.dont);
        });

      }

      template() {
        let { filter } = this.state;

        return /* html */`
          <div role="group" class="NoteInput">
            <input type="text" aria-label="노트" placeholder="노트 내용 작성" />
            <button type="button" class="addNote">추가</button>  
          </div>

          <div role="group" class="NoteFilters">
            <button
              type="button" 
              data-filter="all" 
              ${filter === NoteFilters.all ? 'class="active" disabled' : ''}
            >
              모두 표시
            </button>
            <button
              type="button" 
              data-filter="done"
              ${filter === NoteFilters.done ? 'class="active" disabled' : ''}
            >
              수행한 노트
            </button>
            <button
              type="button" 
              data-filter="dont" 
              ${filter === NoteFilters.dont ? 'class="active" disabled' : ''}
            >
              수행할 노트
            </button>
          </div>

          <ul class="NoteList">
            ${this.filterNotes().map(note => {
              return /* html */`
                <li class="NoteItem" data-id="${note.id}">
                  <label>
                    <input
                      type="checkbox"
                      class="toggleNote" 
                      ${note.done ? 'checked' : ''} 
                    />
                    <span ${note.done ? 'style="text-decoration: line-through"' : ''}>${note.content}</span>
                  </label>
                  <button
                    type="button"
                    class="deleteNote"
                  >
                    삭제
                  </button>
                </li>
              `;
            }).join('')}
          </ul>
        `;
      }

      filterNotes() {
        const { filter, notes } = this.state;

        return notes.filter(note => {
          switch(filter) {
            case NoteFilters.done:
              return note.done;
            case NoteFilters.dont:
              return !note.done;
            case NoteFilters.all:
            default:
              return note;
          }
        });
      }

      addNote(value) {
        this.setState({
          notes: [
            ...this.state.notes,
            {
              id: Component.generateId({ prefix: 'note', digit: 5 }),
              content: value,
            }
          ]
        });
      }

      toggleNote(target) {
        this.setState({
          notes: this.state.notes.map(note => {
            if (note.id === target.closest('[data-id]').dataset.id) {
              note.done = !note.done;
            }
            return note;
          })
        })
      }

      deleteNote(target) {
        this.setState({
          notes: this.state.notes.filter(note => note.id !== target.closest('[data-id]').dataset.id),
        });
      }

      changeFilter(filterKey) {
        this.setState({ filter: filterKey });
      }
    }

  </script>

  <script data-type="main">

    new NoteApp(document.getElementById('NoteApp'));

  </script>

</body>
</html>